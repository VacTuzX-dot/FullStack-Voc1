---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Sign Up - อินEar">
  <div class="signup-page">
    <!-- Background -->
    <div class="signup-bg">
      <img src="/images/bg.png" alt="Background" />
      <div class="bg-overlay"></div>
    </div>
    
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6 col-xl-5">
          <div class="signup-card">
            <div class="card-body p-4 p-md-5">
              <div class="text-center mb-4">
                <h3 class="fw-bold text-white">
                  <i class="bi bi-person-plus me-2"></i>
                  สมัครสมาชิก
                </h3>
                <p class="text-white-50">สร้างบัญชีผู้ใช้ใหม่</p>
              </div>
              
              <form id="signupForm">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label for="prefix" class="form-label text-light">
                      <i class="bi bi-person-badge me-1"></i>คำนำหน้า
                    </label>
                    <select class="form-control form-input" id="prefix" required>
                      <option value="">-- เลือก --</option>
                      <option value="นาย">นาย</option>
                      <option value="นาง">นาง</option>
                      <option value="นางสาว">นางสาว</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label for="firstname" class="form-label text-light">
                      <i class="bi bi-person me-1"></i>ชื่อ
                    </label>
                    <input type="text" class="form-control form-input" id="firstname" placeholder="กรอกชื่อ" required />
                  </div>
                  <div class="col-md-5">
                    <label for="lastname" class="form-label text-light">
                      <i class="bi bi-person me-1"></i>นามสกุล
                    </label>
                    <input type="text" class="form-control form-input" id="lastname" placeholder="กรอกนามสกุล" required />
                  </div>
                </div>

                <div class="row g-3 mt-1">
                  <div class="col-md-4">
                    <label for="sex" class="form-label text-light">
                      <i class="bi bi-gender-ambiguous me-1"></i>เพศ
                    </label>
                    <select class="form-control form-input" id="sex" required>
                      <option value="">-- เลือก --</option>
                      <option value="ชาย">ชาย</option>
                      <option value="หญิง">หญิง</option>
                      <option value="อื่นๆ">อื่นๆ</option>
                    </select>
                  </div>
                  <div class="col-md-8">
                    <label for="birthday" class="form-label text-light">
                      <i class="bi bi-calendar-date me-1"></i>วันเกิด
                    </label>
                    <input type="date" class="form-control form-input" id="birthday" required />
                  </div>
                </div>

                <div class="mb-3 mt-3">
                  <label for="address" class="form-label text-light">
                    <i class="bi bi-geo-alt me-1"></i>ที่อยู่
                  </label>
                  <textarea class="form-control form-input" id="address" rows="2" placeholder="กรอกที่อยู่" required></textarea>
                </div>
                
                <div class="mb-3">
                  <label for="email" class="form-label text-light">
                    <i class="bi bi-envelope me-1"></i>อีเมล
                  </label>
                  <input type="email" class="form-control form-input" id="email" placeholder="you@example.com" required />
                </div>
                
                <div class="mb-3">
                  <label for="username" class="form-label text-light">
                    <i class="bi bi-at me-1"></i>ชื่อผู้ใช้
                  </label>
                  <input type="text" class="form-control form-input" id="username" placeholder="กรอกชื่อผู้ใช้" required />
                </div>
                
                <div class="mb-3">
                  <label for="password" class="form-label text-light">
                    <i class="bi bi-lock me-1"></i>รหัสผ่าน
                  </label>
                  <input type="password" class="form-control form-input" id="password" placeholder="กรอกรหัสผ่านอย่างน้อย 6 ตัวอักษร" minlength="6" required />
                </div>
                
                <div class="mb-3">
                  <label for="confirmPassword" class="form-label text-light">
                    <i class="bi bi-lock-fill me-1"></i>ยืนยันรหัสผ่าน
                  </label>
                  <input type="password" class="form-control form-input" id="confirmPassword" placeholder="ยืนยันรหัสผ่าน" minlength="6" required />
                </div>
                
                <div class="form-check mb-4">
                  <input class="form-check-input" type="checkbox" id="terms" required />
                  <label class="form-check-label text-light" for="terms">
                    ยอมรับ <a href="#" class="text-primary">เงื่อนไขการใช้งาน</a>
                  </label>
                </div>
                
                <div class="d-grid">
                  <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-person-plus me-2"></i>
                    สมัครสมาชิก
                  </button>
                </div>
                
                <div class="text-center mt-4">
                  <small class="text-light">
                    มีบัญชีอยู่แล้ว? <a href="/signin" class="text-primary text-decoration-none">เข้าสู่ระบบ</a>
                  </small>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  .signup-page {
    position: relative;
    min-height: calc(100vh - 76px);
    display: flex;
    align-items: center;
  }
  
  .signup-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
  }
  
  .signup-bg img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0.7;
  }
  
  .bg-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.8) 100%);
  }
  
  .signup-card {
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
  }
  
  .form-input {
    background: rgba(255, 255, 255, 0.1) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    color: #fff !important;
    transition: all 0.3s ease;
  }
  
  .form-input:focus {
    background: rgba(255, 255, 255, 0.15) !important;
    border-color: rgba(124, 58, 237, 0.5) !important;
    box-shadow: 0 0 0 0.2rem rgba(124, 58, 237, 0.15) !important;
  }
  
  .form-input::placeholder {
    color: rgba(255, 255, 255, 0.6) !important;
  }
</style>

<script>
  import Swal from 'sweetalert2';
  import { navigate } from 'astro:transitions/client';
  import { API_ENDPOINTS } from '../config/api.js';
  
  document.getElementById('signupForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const password = (document.getElementById('password') as HTMLInputElement)?.value;
    const confirmPassword = (document.getElementById('confirmPassword') as HTMLInputElement)?.value;
    
    if (password.length < 6) {
      Swal.fire({
        title: 'รหัสผ่านสั้นเกินไป',
        text: 'กรุณากรอกรหัสผ่านอย่างน้อย 6 ตัวอักษร',
        icon: 'error',
        timer: 2000,
        showConfirmButton: false
      });
      return;
    }
    
    if (password !== confirmPassword) {
      Swal.fire({
        title: 'รหัสผ่านไม่ตรงกัน',
        text: 'กรุณากรอกรหัสผ่านให้ตรงกัน',
        icon: 'error',
        timer: 2000,
        showConfirmButton: false
      });
      return;
    }
    
    const formData = {
      firstname: (document.getElementById('prefix') as HTMLSelectElement)?.value, // Map Prefix to firstname
      fullname: (document.getElementById('firstname') as HTMLInputElement)?.value, // Map First Name to fullname
      lastname: (document.getElementById('lastname') as HTMLInputElement)?.value,
      sex: (document.getElementById('sex') as HTMLSelectElement)?.value,
      birthday: (document.getElementById('birthday') as HTMLInputElement)?.value,
      address: (document.getElementById('address') as HTMLTextAreaElement)?.value,
      email: (document.getElementById('email') as HTMLInputElement)?.value,
      username: (document.getElementById('username') as HTMLInputElement)?.value,
      password: password
    };
    
    try {
      const res = await fetch(API_ENDPOINTS.register, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
      
      const data = await res.json();
      
      if (res.ok) {
        await Swal.fire({
          title: 'สมัครสมาชิกสำเร็จ!',
          text: 'กรุณาเข้าสู่ระบบ',
          icon: 'success',
          timer: 2000,
          showConfirmButton: false
        });
        navigate('/signin');
      } else {
        Swal.fire({
          title: 'เกิดข้อผิดพลาด',
          text: data.message || 'ไม่สามารถสมัครสมาชิกได้',
          icon: 'error',
          timer: 2000,
          showConfirmButton: false
        });
      }
    } catch (error) {
      Swal.fire({
        title: 'เกิดข้อผิดพลาด',
        text: 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้',
        icon: 'error',
        timer: 2000,
        showConfirmButton: false
      });
    }
  });
</script>
